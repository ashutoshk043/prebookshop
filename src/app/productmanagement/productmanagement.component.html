<div class="d-flex flex-column flex-md-row">
  <app-sidebar #sidebar></app-sidebar>

  <div class="main-content flex-grow-1" [class.sidebar-collapsed]="sidebar.isCollapsed">
    <app-header></app-header>

    <main class="p-3 p-md-5 bg-light min-vh-100">
      <div class="container-fluid">

        <!-- ‚úÖ Product Management Card -->
        <div class="card border-0 shadow-sm mt-4">

          <!-- HEADER -->
          <div class="card-header">
            <div class="row g-2 align-items-center">

              <!-- Search -->
              <div class="col-12 col-md-4">
                <div class="position-relative">
                  <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ps-2 text-secondary"></i>
                  <input type="text" class="form-control ps-5" placeholder="Search products..."
                    (input)="onSearch($event)" />
                </div>
              </div>

              <!-- Import -->
              <div class="col-6 col-md-4">
                <button class="btn btn-outline-primary w-100" (click)="openImportModal()">
                  <i class="bi bi-upload me-2"></i> Import
                </button>
              </div>

              <!-- Add -->
              <div class="col-6 col-md-4">
                <button class="btn btn-primary w-100" (click)="openAddForm('add')">
                  <i class="bi bi-plus-lg me-2"></i> Add Product
                </button>
              </div>

            </div>
          </div>

          <!-- TABLE -->
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light text-uppercase small">
                <tr>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Tags</th>
                  <th>Visibility</th>
                  <th>Status</th>
                  <th>Image</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let product of products">

                  <!-- NAME -->
                  <td>
                    <div class="fw-bold">{{ product.name }}</div>
                    <small class="text-muted">{{ product.description }}</small>
                  </td>

                  <!-- CATEGORY -->
                  <td>
                    <span class="badge bg-primary-subtle text-primary">
                      {{ getCategoryNameById(product.categoryId) }}
                    </span>
                  </td>

                  <!-- TAGS -->
                  <td>
                    <span *ngFor="let tag of product.tags" class="badge bg-info-subtle text-info me-1">
                      {{ tag }}
                    </span>
                  </td>

                  <!-- ONLINE VISIBILITY -->
                  <td>
                    <span class="badge" [ngClass]="product.isOnlineVisible
                        ? 'bg-success-subtle text-success'
                        : 'bg-secondary-subtle text-secondary'">
                      {{ product.isOnlineVisible ? 'Visible' : 'Hidden' }}
                    </span>
                  </td>

                  <!-- ACTIVE STATUS -->
                  <td>
                    <span class="badge" [ngClass]="product.isActive
                        ? 'bg-success-subtle text-success'
                        : 'bg-danger-subtle text-danger'">
                      {{ product.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>

                  <!-- IMAGE -->
                  <td>
                    <img [src]="product.imageUrl || 'assets/no-image.png'" alt="{{ product.name }}" width="90"
                      height="55" style="object-fit: cover; border-radius: 6px;" />
                  </td>

                  <!-- ACTIONS -->
                  <td class="text-end">
                    <div class="btn-group">

                      <!-- EDIT -->
                      <button class="btn btn-sm btn-light" (click)="openAddForm('edit', product)">
                        <i class="bi bi-pencil"></i>
                      </button>

                      <!-- TOGGLE ACTIVE -->
                      <!-- <button class="btn btn-sm btn-light" (click)="toggleAvailability(product)">
                        <i class="bi" [ngClass]="product.isActive
                            ? 'bi-check-circle'
                            : 'bi-x-circle'"></i>
                      </button> -->

                      <!-- DELETE -->
                      <button class="btn btn-sm btn-light text-danger" (click)="deleteProduct(product._id)">
                        <i class="bi bi-trash"></i>
                      </button>

                    </div>
                  </td>

                </tr>
              </tbody>
            </table>
          </div>

          <!-- PAGINATION -->
          <div class="card-footer d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">

            <button class="btn btn-outline-secondary btn-sm" (click)="prevPage()" [disabled]="currentPage === 1">
              ‚Üê Previous
            </button>

            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" *ngFor="let p of pages" [class.active]="p === currentPage">
                <button class="page-link" (click)="goToPage(p)">
                  {{ p }}
                </button>
              </li>
            </ul>

            <button class="btn btn-outline-secondary btn-sm" (click)="nextPage()"
              [disabled]="currentPage === totalPages">
              Next ‚Üí
            </button>

          </div>

        </div>
      </div>
    </main>
  </div>
</div>
<!-- ‚úÖ Import Modal -->
<div class="modal fade show" *ngIf="showImportModal" style="display:block; background:rgba(0,0,0,0.6);">

  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

      <!-- üî∑ Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="bi bi-upload fs-4 me-2"></i>
          Import Products via CSV
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeImportModal()"></button>
      </div>

      <!-- üî∂ Body -->
      <div class="modal-body p-4">

        <!-- Info Box -->
        <div class="alert alert-info d-flex align-items-start mb-4">
          <i class="bi bi-info-circle fs-5 me-2"></i>
          <div>
            Upload a CSV file to import products in bulk.
            Please follow the template format for smooth import.
          </div>
        </div>

        <!-- File Upload -->
        <div class="card border-dashed mb-4 p-4 text-center">
          <i class="bi bi-file-earmark-spreadsheet fs-1 text-primary mb-3"></i>

          <input type="file" class="form-control" accept=".csv" (change)="onFileSelect($event)"
            [disabled]="uploading" />
        </div>

        <!-- Progress Section -->
        <div *ngIf="uploading" class="mb-4">

          <div class="progress mb-3" style="height: 22px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated fw-semibold" role="progressbar"
              [style.width.%]="uploadProgress">
              {{ uploadProgress }}%
            </div>
          </div>

          <!-- Stats -->
          <div class="row text-center">
            <div class="col-md-4">
              <div class="stat-box bg-light">
                <strong>Total</strong>
                <div>{{ totalCount }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-box bg-success text-white">
                <strong>Imported</strong>
                <div>{{ importedCount }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-box bg-danger text-white">
                <strong>Failed</strong>
                <div>{{ failedCount }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Template Download -->
        <button class="btn btn-outline-primary w-100" (click)="downloadTemplate()" [disabled]="uploading">
          <i class="bi bi-download me-2"></i>
          Download CSV Template
        </button>

      </div>

      <!-- üî∑ Footer -->
      <div class="modal-footer justify-content-between">

        <button class="btn btn-outline-secondary" (click)="closeImportModal()" [disabled]="uploading">
          Cancel
        </button>

        <button *ngIf="uploadProgress != 100" class="btn btn-primary px-4" (click)="handleImport()"
          [disabled]="uploading">
          <i class="bi bi-cloud-upload me-2"></i>
          {{ uploading ? 'Uploading...' : 'Start Import' }}
        </button>

        <button *ngIf="uploadProgress == 100" class="btn btn-outline-danger px-4">
          <i class="bi bi-exclamation-circle me-2"></i>
          Check Error Log
        </button>

      </div>

    </div>
  </div>
</div>


<app-product-management-form *ngIf="showForm" [categories]="categories" (close)="closeForm()">
</app-product-management-form>