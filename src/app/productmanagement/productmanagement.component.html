<div class="d-flex flex-column flex-md-row">
  <app-sidebar #sidebar></app-sidebar>

  <div class="main-content flex-grow-1" [class.sidebar-collapsed]="sidebar.isCollapsed">
    <app-header></app-header>

    <main class="p-3 p-md-5 bg-light min-vh-100">
      <div class="container-fluid">

        <!-- ✅ Product Management Card -->
        <div class="card border-0 shadow-sm mt-4">
          <div class="card-header">
            <div class="row g-2 align-items-center">
              <!-- Search Bar -->
              <div class="col-12 col-md-4">
                <div class="position-relative">
                  <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ps-2 text-secondary"></i>
                  <input type="text" class="form-control ps-5" placeholder="Search products..." />
                </div>
              </div>

              <!-- Import Button -->
              <div class="col-6 col-md-4">
                <button class="btn btn-outline-primary w-100" (click)="openImportModal()">
                  <i class="bi bi-upload me-2"></i> Import
                </button>
              </div>

              <!-- Add Product Button -->
              <div class="col-6 col-md-4">
                <button class="btn btn-primary w-100" (click)="openAddModal()">
                  <i class="bi bi-plus-lg me-2"></i> Add Product
                </button>
              </div>
            </div>
          </div>


          <!-- ✅ Responsive Table -->
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light text-uppercase small">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Variant</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Status</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of products">
                  <td class="fw-semibold text-primary">{{ product.id }}</td>
                  <td>
                    <div class="fw-bold">{{ product.productName }}</div>
                    <small class="text-muted">{{ product.description }}</small>
                  </td>
                  <td><span class="badge bg-primary-subtle text-primary">{{ product.category }}</span></td>
                  <td>{{ product.variantType }} / {{ product.unit }}</td>
                  <td>₹{{ product.price }}</td>
                  <td>
                    <span class="badge" [ngClass]="{
                        'bg-success-subtle text-success': product.stock > 20,
                        'bg-warning-subtle text-warning': product.stock <= 20 && product.stock > 0,
                        'bg-danger-subtle text-danger': product.stock == 0
                      }">
                      {{ product.stock }} {{ product.unit }}
                    </span>
                  </td>
                  <td>
                    <span class="badge"
                      [ngClass]="product.available ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'">
                      {{ product.available ? 'Available' : 'Unavailable' }}
                    </span>
                  </td>
                  <td class="text-end">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-light" (click)="openEditModal(product)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-light" (click)="toggleAvailability(product)">
                        <i class="bi" [ngClass]="product.available ? 'bi-check-circle' : 'bi-x-circle'"></i>
                      </button>
                      <button class="btn btn-sm btn-light text-danger" (click)="deleteProduct(product.id)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- ✅ Pagination -->
          <div class="card-footer d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm w-100 w-sm-auto" disabled>← Previous</button>
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item active"><button class="page-link">1</button></li>
              <li class="page-item"><button class="page-link">2</button></li>
              <li class="page-item"><button class="page-link">3</button></li>
            </ul>
            <button class="btn btn-outline-secondary btn-sm w-100 w-sm-auto">Next →</button>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ✅ Add/Edit Modal -->
<div class="modal fade show" *ngIf="showModal" style="display:block; background:rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title">{{ isEditMode ? 'Edit Product' : 'Add Product' }}</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>

      <form [formGroup]="productForm" (ngSubmit)="saveProduct()">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Product Name</label>
              <input type="text" class="form-control" formControlName="productName" placeholder="Enter product name">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Category</label>
              <select class="form-select" formControlName="category">
                <option value="">Select Category</option>
                <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" rows="2" formControlName="description"></textarea>
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Variant</label>
              <select class="form-select" formControlName="variantType">
                <option value="">Select</option>
                <option *ngFor="let v of variants" [value]="v">{{ v }}</option>
              </select>
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Unit</label>
              <select class="form-select" formControlName="unit">
                <option value="">Select</option>
                <option *ngFor="let u of units" [value]="u">{{ u }}</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Price (₹)</label>
              <input type="number" class="form-control" formControlName="price">
            </div>
            <div class="col-6">
              <label class="form-label">Stock</label>
              <input type="number" class="form-control" formControlName="stock">
            </div>
            <div class="col-6">
              <label class="form-label">Ingredients</label>
              <input type="text" class="form-control" formControlName="ingredients">
            </div>
            <div class="col-12 d-flex align-items-center mt-2">
              <input type="checkbox" class="form-check-input me-2" formControlName="available">
              <label class="form-check-label">Available</label>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">{{ isEditMode ? 'Update' : 'Add' }} Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ✅ Import Modal -->
<div class="modal fade show" *ngIf="showImportModal" style="display:block; background:rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">

      <div class="modal-header">
        <h5 class="modal-title">Import Products</h5>
        <button type="button" class="btn-close" (click)="closeImportModal()"></button>
      </div>

      <div class="modal-body text-center">

        <input type="file" class="form-control mb-3" accept=".csv" (change)="onFileSelect($event)"
          [disabled]="uploading" />

        <!-- Progress Bar -->
        <div *ngIf="uploading" class="mb-3">
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
              [style.width.%]="uploadProgress">
              {{ uploadProgress }}%
            </div>
          </div>
          <div>
            <span>Total: {{totalCount}}</span><br>
            <span>Imported: {{importedCount}}</span><br>
            <span>Failed: {{failedCount}}</span><br>
          </div>
        </div>

        <button class="btn btn-outline-primary w-100 mb-2" (click)="downloadTemplate()" [disabled]="uploading">
          <i class="bi bi-file-earmark-arrow-down me-2"></i>
          Download Template
        </button>
      </div>

      <div class="modal-footer" *ngIf="uploadProgress != 100">
        <button class="btn btn-outline-secondary" (click)="closeImportModal()" [disabled]="uploading">
          Cancel
        </button>

        <button class="btn btn-primary" (click)="handleImport()" [disabled]="uploading">
          {{ uploading ? 'Uploading...' : 'Import' }}
        </button>
      </div>
        <div class="modal-footer" *ngIf="uploadProgress == 100">
        <button class="btn btn-outline-danger">
          Check File Log
        </button>
      </div>

    </div>
  </div>
</div>